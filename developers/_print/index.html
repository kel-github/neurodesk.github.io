<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<link rel=canonical type=text/html href=https://kel-github/neurodesk.github.io/developers/>
<link rel=alternate type=application/rss+xml href=https://kel-github/neurodesk.github.io/developers/index.xml>
<meta name=robots content="noindex, nofollow">
<link rel="shortcut icon" href=/neurodesk.github.io/favicons/favicon.ico>
<link rel=apple-touch-icon href=/neurodesk.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/neurodesk.github.io/favicons/android-192x192.png sizes=192x192>
<title>Developers | NeuroDesk</title>
<meta name=description content="Documentation for Developers
">
<meta property="og:title" content="Developers">
<meta property="og:description" content="Documentation for Developers
">
<meta property="og:type" content="website">
<meta property="og:url" content="https://kel-github/neurodesk.github.io/developers/"><meta property="og:site_name" content="NeuroDesk">
<meta itemprop=name content="Developers">
<meta itemprop=description content="Documentation for Developers
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Developers">
<meta name=twitter:description content="Documentation for Developers
">
<link rel=preload href=/neurodesk.github.io/scss/main.min.73d5be94f5e99c5a61460fa5b435757ce8ab87f13970655d157965b5df2b9419.css as=style>
<link href=/neurodesk.github.io/scss/main.min.73d5be94f5e99c5a61460fa5b435757ce8ab87f13970655d157965b5df2b9419.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=/neurodesk.github.io/css/prism.css>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-221108279-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/neurodesk.github.io/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">NeuroDesk</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/neurodesk.github.io/docs/><span>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/neurodesk.github.io/applications/><span>Applications</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/neurodesk.github.io/developers/><span class=active>Developers</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/neurodesk.github.io/tutorials/><span>Tutorials</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/NeuroDesk target=_blank><i class="fab fa-github"></i><span>GitHub</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://twitter.com/neuro_desk target=_blank><i class="fab fa-twitter"></i><span>News/Twitter</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/neurodesk.github.io/offline-search-index.961c263d86d3af0292ca0fab6101f3a9.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/neurodesk.github.io/developers/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Developers</h1>
<div class=lead>Documentation for Developers</div>
<ul>
<li>1: <a href=#pg-95ed7c5681d2faa66b764be030124e59>Architecture</a></li>
<ul>
<li>1.1: <a href=#pg-d2ee0d937ef9e23352513cee17667503>Neurodesktop Release Process</a></li>
<li>1.2: <a href=#pg-563591a7e975c9f90c317bf391d61e75>Neurodesk Architecture</a></li>
<li>1.3: <a href=#pg-4e0ebcb307acf80f9f0f9d5fcf769e45>Neurodesktop Dev</a></li>
</ul>
<li>2: <a href=#pg-f347e8a68ab88feb2dbd40d7268e3b66>Documentation</a></li>
<ul>
<li>2.1: <a href=#pg-43caa4b2a10189e2fa053496d5d16e07>Local Hugo Docsy</a></li>
</ul>
<li>3: <a href=#pg-fd28a1b5010f2ff02bb480802674fb39>How to add new tools</a></li>
<ul>
<li>3.1: <a href=#pg-e24a02244ddbf4a83fcf0095e3003590>Add tools</a></li>
<li>3.2: <a href=#pg-f706aedba5bc93ee895c966642b91365>Menu entries</a></li>
</ul>
<li>4: <a href=#pg-f89498a0fd2d201e1dc7e27d7be9f337>Transparent Singularity</a></li>
<ul>
</ul>
<li>5: <a href=#pg-9dfb256e35d7dd91e05a33ec675f72e4>Neurodesk CVMFS</a></li>
<ul>
<li>5.1: <a href=#pg-7d2cf5c0520f7ea412450bf2c795e035>Setup CVMFS Proxy</a></li>
<li>5.2: <a href=#pg-d12eca793afb912a040cd1c047606b56>CVMFS architecture</a></li>
<li>5.3: <a href=#pg-9110e9d9e3591f58026d3d52fc7e72cb>Setup Stratum 0 server</a></li>
<li>5.4: <a href=#pg-c25efc2b343b28af52b4173ce3a803a3>Setup Stratum 1 server</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-95ed7c5681d2faa66b764be030124e59>1 - Architecture</h1>
<div class=lead>The architecture of the Neurodesk ecosystem</div>
</div>
<div class=td-content>
<h1 id=pg-d2ee0d937ef9e23352513cee17667503>1.1 - Neurodesktop Release Process</h1>
<div class=lead>A description of what to do to create new release of our Neurodesktop</div>
<ol>
<li>Check if the last automated build ran OK: <a href=https://github.com/NeuroDesk/neurodesktop/actions>https://github.com/NeuroDesk/neurodesktop/actions</a></li>
<li>Run this build date and test if everything is ok and no regression happened</li>
<li>Check what changes where made since the last release: <a href=https://github.com/NeuroDesk/neurodesktop/commits/main>https://github.com/NeuroDesk/neurodesktop/commits/main</a></li>
<li>Summarize the main changes and copy this to the Release History and the news section:</li>
</ol>
<ul>
<li><a href=https://neurodesk.github.io/docs/neurodesktop/release-history/>https://neurodesk.github.io/docs/neurodesktop/release-history/</a></li>
<li><a href=https://neurodesk.github.io/blog/releases/>https://neurodesk.github.io/blog/releases/</a></li>
</ul>
<ol start=5>
<li>Change the version of the latest desktop in <a href=https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/data/neurodesktop.toml>https://github.com/NeuroDesk/neurodesk.github.io/blob/hugo-docsy/data/neurodesktop.toml</a></li>
<li>Commit all changes</li>
<li>Tweet a quick summary of the changes and announce new version: <a href=https://twitter.com/neuro_desk>https://twitter.com/neuro_desk</a></li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-563591a7e975c9f90c317bf391d61e75>1.2 - Neurodesk Architecture</h1>
<div class=lead>The architecture of the Neurodesk ecosystem</div>
<h1 id=layers>Layers</h1>
<p>Neurodesktop: <a href=https://github.com/NeuroDesk/neurodesktop>https://github.com/NeuroDesk/neurodesktop</a></p>
<ul>
<li>docker container with interface modifications</li>
<li>contains tools necessary to manage workflows in sub-containers: vscode, git</li>
<li>CI: builds docker image and tests if it runs; tests if CVMFS servers are OK before deployment</li>
<li>CD: pushes images to github & docker registry</li>
</ul>
<p>Neurocommand: <a href=https://github.com/NeuroDesk/neurocommand>https://github.com/NeuroDesk/neurocommand</a></p>
<ul>
<li>script to install and manage multiple containers using transparent singularity on any linux system</li>
<li>this repo also handles the creation of menu entries in a general form applicable to different desktop environments</li>
<li>this repo can be re-used in other projects like CVL and when installing it on a bare-metal workstations</li>
<li>CI: tests if containers can be installed</li>
<li>CD: this repo checks if containers requested in apps.json file are availabe on object storage and if not converts the singularity containers based on the docker containers and uploads them to object storage</li>
</ul>
<p>transparent-singularity: <a href=https://github.com/NeuroDesk/transparent-singularity>https://github.com/NeuroDesk/transparent-singularity</a></p>
<ul>
<li>script to install neuro-sub-containers, installers are called by neurocommand</li>
<li>this repo provides a way of using our containers on HPCs for large scale processing of the pipelines (including the support of SLURM and other job schedulers)</li>
<li>CI: test if exposing of binaries from container works</li>
</ul>
<p>Neurocontainers: <a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a></p>
<ul>
<li>build scripts for neuro-sub-containers</li>
<li>CI: building and testing of containers</li>
<li>CD: pushing containers to github and dockerhub registry</li>
</ul>
<p>Neurodocker: <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a></p>
<ul>
<li>fork of neurodocker project</li>
<li>provides recipes for our containers built</li>
<li>we are providing pull requests back of recipes</li>
<li>CI: handled by <a href=https://github.com/ReproNim/neurodocker>neurodocker</a> - testing of generating container recipes</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4e0ebcb307acf80f9f0f9d5fcf769e45>1.3 - Neurodesktop Dev</h1>
<div class=lead>Testing the latest dev version of Neurodesktop</div>
<div class="alert alert-warning" role=alert>
<h4 class=alert-heading>Warning</h4>
For development and testing only. Not recommended for production use
</div>
<h2 id=building-neurodesktop-dev>Building neurodesktop-dev</h2>
<p>Dev builds can be triggered by Neurodesk admins from <a href=https://github.com/NeuroDesk/neurodesktop/actions/workflows/build-neurodesktop-dev.yml>https://github.com/NeuroDesk/neurodesktop/actions/workflows/build-neurodesktop-dev.yml</a></p>
<h2 id=running-latest-neurodesktop-dev>Running latest neurodesktop-dev</h2>
<h3 id=linux>Linux</h3>
<pre class="language-shell command-line" data-prompt=$ data-output=3-7>
<code>docker pull vnmd/neurodesktop-dev:latest
sudo docker run \
  --shm-size=1gb -it --cap-add SYS_ADMIN \
  --security-opt apparmor:unconfined --device=/dev/fuse \
  --name neurodesktop-dev \
  -v ~/neurodesktop-storage:/neurodesktop-storage \
  -e HOST_UID="$(id -u)" -e HOST_GID="$(id -g)" \
  -p 8080:8080 -h neurodesktop-dev \
  vnmd/neurodesktop-dev:latest</code>
</pre>
<h3 id=windows>Windows</h3>
<pre class="language-batch command-line" data-prompt=">">
<code>docker pull vnmd/neurodesktop-dev:latest
docker run --shm-size=1gb -it --cap-add SYS_ADMIN --security-opt apparmor:unconfined --device=/dev/fuse --name neurodesktop -v C:/neurodesktop-storage:/neurodesktop-storage -p 8080:8080 -h neurodesktop-dev vnmd/neurodesktop-dev:latest</code>
</pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f347e8a68ab88feb2dbd40d7268e3b66>2 - Documentation</h1>
<div class=lead>How to edit the documentation</div>
</div>
<div class=td-content>
<h1 id=pg-43caa4b2a10189e2fa053496d5d16e07>2.1 - Local Hugo Docsy</h1>
<div class=lead>How to edit the documentation</div>
<h2 id=local-hugo-docsy>Local Hugo Docsy</h2>
<h3 id=clone-repository>Clone repository</h3>
<p>Using SSH</p>
<p><code>git clone --recurse-submodules git@github.com:NeuroDesk/neurodesk.github.io.git</code></p>
<p>or Https:</p>
<p><code>git clone --recurse-submodules https://github.com/NeuroDesk/neurodesk.github.io.git</code></p>
<h3 id=if-you-cloned-without---recurse-submodules>If you cloned without &ndash;recurse-submodules</h3>
<p>Run the following command to pull submodules</p>
<p><code>git submodule update --init --recursive --remote</code></p>
<h3 id=download-hugo-binary>Download Hugo binary</h3>
<p>Hugo releases are on <a href=https://github.com/gohugoio/hugo/releases>https://github.com/gohugoio/hugo/releases</a></p>
<p>Download latest version of hugo extended</p>
<p>e.g. for windows: <a href=https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_extended_0.88.1_Windows-64bit.zip>https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_extended_0.88.1_Windows-64bit.zip</a></p>
<h3 id=start-local-hugo-server>Start local hugo server</h3>
<p>Extract hugo binary (hugo.exe) to your neurodesk.github.io dir</p>
<p>Run server for windows: <code>.\hugo.exe server --disableFastRender</code></p>
<p>Once started, dev website will be accessible via http://localhost:1313</p>
<h3 id=update-docsy-theme-submodule>Update docsy theme submodule</h3>
<pre class="language-shell command-line" data-prompt=$><code>git submodule update --remote
git add themes/
git commit -m "Updating theme submodule"
git push origin hugo-docsy</code></pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fd28a1b5010f2ff02bb480802674fb39>3 - How to add new tools</h1>
<div class=lead>How to add new tools to neurodesk</div>
</div>
<div class=td-content>
<h1 id=pg-e24a02244ddbf4a83fcf0095e3003590>3.1 - Add tools</h1>
<div class=lead>Add a tool to neurodesktop</div>
<p>The goal of <em>neurodesk</em> is to provide users with a large choice of tools to use in their pipelines.
Use the guide below to add a tool to <em>neurodesktop</em> or <em>neurocontainers</em>.</p>
<h2 id=guiding-principles>Guiding principles</h2>
<p>To decide if a tool should be packaged in a singularity container in <em>neurocontainers</em> or be installed in the <em>neurodesktop</em> container we are currently following these guiding principles:</p>
<ol>
<li><em>neurodesk</em> is not a package manager. This means we are not distributing tools in containers that can easily be installed via a standard package manager</li>
<li><em>neurodesk</em> allows users to have multiple versions of tools in parallel via <a href=https://lmod.readthedocs.io/en/latest/>lmod</a>, this means that if different versions of a tool can&rsquo;t be installed in parallel we package the tool inside a container.</li>
<li><em>neurodesk</em> aims to provide tooling to link tools from different containers (such as workflow managers like nipype or nextflow). This means that if a tool is required to coordinate various container-tools, it should be in the <em>neurodesktop</em> container.</li>
</ol>
<p>Examples:</p>
<table>
<thead>
<tr>
<th></th>
<th>easy install</th>
<th>coordinates containers</th>
<th>small in size</th>
<th>latest version is ok</th>
<th>useful to most users</th>
<th>Conclusion</th>
</tr>
</thead>
<tbody>
<tr>
<td>git</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>lmod</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>nipype</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>vscode</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>itksnap</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>container?</td>
</tr>
<tr>
<td>convert3D</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>fsl</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>mrtrix</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>freesurfer</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
</tbody>
</table>
<h2 id=adding-new-recipes>Adding new recipes</h2>
<p>Refer to <a href=https://github.com/NeuroDesk/neurodocker>neurodocker</a> for more information on neurodocker recipes</p>
<h2 id=build-container>Build container</h2>
<p>To build a container, set up environment with:</p>
<ol>
<li>Docker, the version in our CI environment</li>
<li>Python, the version in our CI environment</li>
</ol>
<p>And then follow these steps:</p>
<ol>
<li>Sync/modify Neurodocker, the dependency we are using to build containers:
<ol>
<li>Press &ldquo;Fetch upstream&rdquo; in <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a> to check if our fork of Neurodocker is already up-to-date</li>
<li>If there are upstream commits that are not synced yet, open an issue in <a href=https://github.com/NeuroDesk/neurocontainers/issues>https://github.com/NeuroDesk/neurocontainers/issues</a>, requesting one of Neurodesk admins to pull-in latest changes from Neurodocker upstream into our fork of Neurodocker</li>
<li>If relevant to your project, add recipe to neurodocker (<a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a>) and create a pull request to neurodocker (add new tool in a branch!)</li>
</ol>
</li>
<li>Clone the neurocontainers repository:
<div class="alert alert-primary" role=alert>
<p>Optional: Fork neurocontainers and setup github actions</p>
<ol>
<li>Fork <a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a> into your account.</li>
<li>Go to your neurocontainers fork.</li>
<li>If Actions tab is missing, go to Settings > Actions. Select Allow all actions. Then Save.</li>
<li>In the actions tab, select &ldquo;I understand my workflows, go ahead and enable them&rdquo;</li>
</ol>
<p>Pushes to the recipes in your fork will now trigger actions to build the respective docker container, and push them to your Github Packages.</p>
</div>
</li>
</ol>
<p><a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a></p>
<pre class="language-shell command-line" data-prompt=$><code>git clone https://github.com/NeuroDesk/neurocontainers/</code></pre>
<ol start=3>
<li>Copy the directory template and rename to <em>newapp</em> in <code>neurocontainers/recipes</code></li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>cd neurocontainers/recipes
cp -R template newapp</code></pre>
<ol start=4>
<li>Modify <code>build.sh</code> in <code>neurocontainers/recipes/newapp</code> to build your application and update README.md (make sure the version is correct in the README!)</li>
</ol>
<pre class="language-shell command-line" data-prompt=$ data-output=2-3><code>cd newapp
(edit build.sh as required)
(edit README.md as required)</code></pre>
<p>Upload your application to object storage first if needed, so you can then download it in build.sh (ask for instructions about this if you don&rsquo;t know the key, and never share it anywhere public!)</p>
<ol start=5>
<li>Run update-builders.sh - This will auto-create the CI workflow for the application (or manually duplicate the template file and rename all occurances of template to <em>newapp</em>)</li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>cd ../..
sh update-builders.sh</code></pre>
<blockquote>
<p>if the CI build runs out of space, add the application to the following txt to add additional space.
<a href=https://github.com/NeuroDesk/neurocontainers/blob/master/.github/workflows/free-up-space-list.txt>https://github.com/NeuroDesk/neurocontainers/blob/master/.github/workflows/free-up-space-list.txt</a>.
Note this, significantly increases CI run time, only use in cases of space errors.</p>
</blockquote>
<ol start=6>
<li>
<p>Build and test the container locally</p>
<ol>
<li>clone our fork of Neurodocker: git clone <a href=https://github.com/NeuroDesk/neurodocker/>https://github.com/NeuroDesk/neurodocker/</a></li>
<li>install neurodocker: cd neurodocker; python -m pip install .</li>
<li>run the build script with the &ndash;debug flag: <a href=https://github.com/NeuroDesk/neurocontainers/blob/master/recipes/lcmodel/build.sh>https://github.com/NeuroDesk/neurocontainers/blob/master/recipes/lcmodel/build.sh</a></li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>chmod +x build.sh
./build.sh -debug</code></pre>
<ol start=4>
<li>test running some commands within the container that should be available in your local docker container repository</li>
<li>if your application requires a Matlab Runtime and you get an error about shared library &ldquo;libmwlaunchermain.so&rdquo; not found, check which version of the runtime was installed by the build script</li>
</ol>
</li>
<li>
<p>Update changes in local git repository</p>
</li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>git add recipes/newapp/build.sh recipes/newapp/README.md .github/workflows/newapp.yml
git config user.email "the email that you use for github"
git config user.name "your name"
git commit</code></pre>
<ol start=8>
<li>Generate git personal access token (if you don’t have one already)</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Browse to https://github.com/NeuroDesk/neurocontainers/
Press on your picture in upper right corner --&gt; Setting --&gt; Developer Settings --&gt; Personal Access Token
Press on “generate personal access token”
Write something in “Notes” (doesn’t matter what, it’s for your own use)
Check “repo”
Check “Workflow”
Press “Generate Token” at the bottom
Copy the token displayed on the screen into a file, so you’ll have it later
</code></pre></div><ol start=9>
<li>Test the container locally, and if successful push repo to trigger the automatic build on GitHub</li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>git pull
git push</code></pre>
<ol start=10>
<li>
<p>Go to neurocontainers/actions. Check that the most recent workflow run in the list terminated successfully (green). Otherwise, click on it, click on “build docker”, and the line that caused the error will be highlighted</p>
</li>
<li>
<p>Find your new package under <a href="https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers">https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers</a></p>
<p>Enter the name of the package in the search box, and verify that the full package name shows up in the format <em>toolName_toolVersion</em></p>
</li>
<li>
<p>Obtain <em>buildDate</em> by clicking on the full package name that came up in the search. The build date will be the newest date shown under <strong>Recent tagged image versions</strong></p>
</li>
<li>
<p>Use <em>toolName</em>, <em>toolVersion</em> and <em>buildDate</em> from the previous two steps to manually download the package by typing the following in a terminal open in Neurodesktop</p>
</li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>bash /neurocommand/local/fetch_and_run.sh toolName toolVersion buildDate
ml toolName/toolVersion</code></pre>
<p>For example:
If the full package name that comes up in the step 11 is itksnap_3.8.0, and the newest date under <strong>Recent tagged image versions</strong> is 20210322</p>
<p>The command to use in a terminal open in Neurodesktop is:</p>
<pre class="language-shell command-line" data-prompt=$><code>bash /neurocommand/local/fetch_and_run.sh itksnap 3.8.0 20210322
ml toolName/toolVersion</code></pre>
<div class="alert alert-warning" role=alert>
<h4 class=alert-heading>Depreciation notice</h4>
<p>For VNM users use:</p>
<pre class="language-shell command-line" data-prompt=$><code>bash /neurodesk/local/fetch_and_run.sh toolName toolVersion buildDate
ml toolName/toolVersion</code></pre>
</div>
<ol start=14>
<li>Test the new container. Run some commands, to see all is good</li>
</ol>
<p>If the container doesn&rsquo;t work yet, it&rsquo;s sometimes useful to try and troubleshoot it and install missing libraries. This can be achieved by running it in a writable mode with fakeroot enabled:</p>
<pre class="language-shell command-line" data-prompt=$><code>SINGULARITY_BINDPATH=''; singularity shell --writable --fakeroot /neurodesktop-storage/containers/toolName_toolVersion_buildDate/toolName_toolVersion_buildDate.simg</code></pre>
<ol start=15>
<li>Fork <a href=https://github.com/NeuroDesk/neurocommand/>https://github.com/NeuroDesk/neurocommand/</a> to your Github account</li>
<li>Edit an entry for your package in your fork of neurocommand/blob/main/neurodesk/apps.json based on one of the other entries (generating one menu item for opening a terminal inside the containers, and one menu item for the GUI, if relevant). Notice that in the json file, the version field should contain the <em>buildDate</em></li>
<li>Include an icon file in your fork of neurocommand/tree/main/neurodesk/icons</li>
<li>Send a pull request from your fork of neurocommand to <a href=https://github.com/NeuroDesk/neurocommand/>https://github.com/NeuroDesk/neurocommand/</a></li>
<li>When the pull request is merged by Neurodesk admins, it will trigger an action to build the singularity container, distribute it in all object storage locations and on CVMFS, and it will update the menus in the desktop image on the next daily build</li>
<li>Check in the dev build if everything is ok before releasing a new version of Neurodesktop:</li>
</ol>
<pre class="language-shell command-line" data-prompt=$><code>sudo docker pull vnmd/neurodesktop-dev:latest && sudo docker run   --shm-size=1gb -it --privileged --name neurodesktop   -v ~/neurodesktop-storage:/neurodesktop-storage   -e HOST_UID="$(id -u)" -e HOST_GID="$(id -g)"   -p 8080:8080 -h neurodesktop-dev   vnmd/neurodesktop-dev:latest</code></pre>
<ol start=21>
<li>Consider contributing a tutorial about the new tool: <a href=https://github.com/NeuroDesk/neurodesk.github.io/tree/hugo-docsy/content/en/tutorials>https://github.com/NeuroDesk/neurodesk.github.io/tree/hugo-docsy/content/en/tutorials</a></li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f706aedba5bc93ee895c966642b91365>3.2 - Menu entries</h1>
<div class=lead>Menu entries in neurodesktop</div>
<h2 id=menu-entry>Menu entry</h2>
<p>As we want to propose several versions of the tools, each piece of software should have its own submenu under <code>VNM Neuroimaging</code>.
To do so, you first have to add a submenu to <code>menus/vnm-applications.menu</code> by adding:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- [[Tool Name]] submenu --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;Menu&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Name&gt;</span>[[Tool Name]]<span style=color:#204a87;font-weight:700>&lt;/Name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Directory&gt;</span>vnm-[[tool-name]].directory<span style=color:#204a87;font-weight:700>&lt;/Directory&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Include&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;And&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;Category&gt;</span>[[Tool-Name]]<span style=color:#204a87;font-weight:700>&lt;/Category&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/And&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/Include&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/Menu&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- End [[Tool Name]] --&gt;</span>
</code></pre></div><p>The following table shows the formatting rules to follow:</p>
<table>
<thead>
<tr>
<th>Placeholder</th>
<th>Rule</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[[Tool name]]</code></td>
<td>Capitalized, spaces</td>
<td><code>ITK snap</code></td>
</tr>
<tr>
<td><code>[[tool-name]]</code></td>
<td>Lower case, no spaces (use <code>-</code> instead)</td>
<td><code>itk-snap</code> or <code>itksnap</code></td>
</tr>
<tr>
<td><code>[[Tool-name]]</code></td>
<td>Capitalized, no spaces (use <code>-</code> instead)</td>
<td><code>ITK-snap</code></td>
</tr>
</tbody>
</table>
<p>Next, we have to create the submenu itself as we referenced it by <code>vnm-[[tool-name]].directory</code>. To do so, create the file <code>menus/submenus/vnm-[[tool-name]].directory</code> and add the following information inside:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Directory</span>
</code></pre></div><p>If a specific icon is available in the <code>menus/icons</code> directory, replace <code>[[icon-name]]</code> by its name. Otherwise, use <code>vnm</code>.</p>
<h2 id=create-the-application>Create the application</h2>
<p>Finally, we have to create the actual application by creating the file <code>menus/applications/vnm-[[tool-name]]-[[0.0.0]].desktop</code>. The name of this file must contain the version of the tool (once again to allow multiple versions to live inside the same directory). Add the following description to this file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]] [[(Install only)]]</span>
<span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]]</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The description of what clicking on this application does. # This will be the tooltip of the application.</span>
<span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The command used to run the application.</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
<span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool-name]]</span>
<span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true # or false</span>
</code></pre></div><p>The important part here is the value of <code>Exec</code>. If the tool is in the form of a singularity image, you should run the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh <span style=color:#ce5c00;font-weight:700>[[</span>tool-name<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>0.0.0<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>YYYYMMDD<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>cmd<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>args<span style=color:#ce5c00;font-weight:700>]]</span>
</code></pre></div><p>What <code>fetch_and_run.sh</code> does is check if the image is already installed as a module. If not, it checks whether it can be installed or not (return <code>1</code> if not possible). After that, it installs the image as a module.
If <code>[[cmd]]</code> is specified, once the image is installed, it runs the command by giving the arguments from <code>[[args]]</code>.
Here are two examples for FreeSurfer and FreeView. This first one only installs the image as a module:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span>
</code></pre></div><p>And this does the same but runs FreeView afterward:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span> freeview
</code></pre></div><p>The resulting <code>.desktop</code> file corresponding to FreeView contains:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
<span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Start FreeView 6.0.1</span>
<span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 20200506 freeview</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/run.png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
<span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeSurfer</span>
<span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f89498a0fd2d201e1dc7e27d7be9f337>4 - Transparent Singularity</h1>
<div class=lead>For more advanced users who wish to use Transparent Singularity directly</div>
<p>Transparent singularity is here <a href=https://github.com/NeuroDesk/transparent-singularity/>https://github.com/NeuroDesk/transparent-singularity/</a></p>
<p>This project allows to use singularity containers transparently on HPCs, so that an application inside the container can be used without adjusting any scripts or pipelines (e.g. nipype).</p>
<h2 id=important-add-bind-points-to-bashrc-before-executing-this-script>Important: add bind points to .bashrc before executing this script</h2>
<p>This script expects that you have adjusted the Singularity Bindpoints in your .bashrc, e.g.:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>export SINGULARITY_BINDPATH=&#34;/gpfs1/,/QRISdata,/data&#34;
</code></pre></div><h2 id=this-gives-you-a-list-of-all-tested-images-available-in-neurodesk>This gives you a list of all tested images available in neurodesk:</h2>
<p><a href=https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt>https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>curl -s https://raw.githubusercontent.com/NeuroDesk/neurodesk/master/cvmfs/log.txt
</code></pre></div><h2 id=clone-repo-into-a-folder-with-the-intented-image-name>Clone repo into a folder with the intented image name</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>git clone https://github.com/NeuroDesk/transparent-singularity convert3d_1.0.0_20210104
</code></pre></div><h2 id=install>Install</h2>
<p>This will create scripts for every binary in the container located in the $DEPLOY_PATH inside the container. It will also create activate and deactivate scripts and module files for lmod (<a href=https://lmod.readthedocs.io/en/latest/>https://lmod.readthedocs.io/en/latest/</a>)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd convert3d_1.0.0_20210104
./run_transparent_singularity.sh convert3d_1.0.0_20210104
</code></pre></div><h2 id=options-for-transparent-singularity>Options for Transparent singularity:</h2>
<ul>
<li><code>--storage</code> - this option can be used to force a download from docker, e.g.: <code>--storage docker</code></li>
<li><code>--container</code> - this option can be used to explicitly define the container name to be downloaded</li>
<li><code>--unpack</code> - this will unpack the singularity container so it can be used on systems that do not allow to open simg / sif files for security reasons, e.g.: <code>--unpack true</code></li>
<li><code>--singularity-opts</code> - this will be passed on to the singularity call, e.g.: <code>--singularity-opts '--bind /cvmfs'</code></li>
</ul>
<h1 id=use-in-module-system-lmod>Use in module system LMOD</h1>
<p>Add the module folder path to $MODULEPATH</p>
<h1 id=manual-activation-and-deactivation-in-case-module-system-is-not-available-this-will-add-the-paths-to-the-bashrc>Manual activation and deactivation (in case module system is not available). This will add the paths to the .bashrc</h1>
<h2 id=activate>Activate</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>source activate_convert3d_1.0.0_20210104.sh
</code></pre></div><h2 id=deactivate>Deactivate</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>source deactivate_convert3d_1.0.0_20210104.sif.sh
</code></pre></div><h2 id=uninstall-container-and-cleanup>Uninstall container and cleanup</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>./ts_uninstall.sh
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9dfb256e35d7dd91e05a33ec675f72e4>5 - Neurodesk CVMFS</h1>
<div class=lead>How to interact with our CVMFS service.</div>
</div>
<div class=td-content>
<h1 id=pg-7d2cf5c0520f7ea412450bf2c795e035>5.1 - Setup CVMFS Proxy</h1>
<div class=lead>Setup CVMFS Proxy server</div>
<p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy. We currently don&rsquo;t run any proxy servers but it would be important for using it on a cluster.</p>
<pre class="language-batch command-line" data-prompt=">" data-output=2-4>
<code>docker run --shm-size=1gb -it --privileged --name neurodesktop `
-v C:/neurodesktop-storage:/neurodesktop-storage -p 8080:8080 `
-h neurodesktop-20220222 `
vnmd/neurodesktop:20220222</code>
</pre>
<h1 id=setup-a-cvmfs-proxy-server>Setup a CVMFS proxy server</h1>
<pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install -y squid</code>
</pre>
<p>Open the <code>squid.conf</code>and use the following configuration</p>
<pre class="language-shell command-line" data-prompt=$>
<code>sudo vi /etc/squid/squid.conf</code>
</pre>
<pre class=language-shell>
<code># List of local IP addresses (separate IPs and/or CIDR notation) allowed to access your local proxy
#acl local_nodes src YOUR_CLIENT_IPS

# Destination domains that are allowed
#acl stratum_ones dstdomain .YOURDOMAIN.ORG
#acl stratum_ones dstdom_regex YOUR_REGEX
acl stratum_ones dst 140.238.211.92

# Squid port
http_port 3128

# Deny access to anything which is not part of our stratum_ones ACL.
http_access deny !stratum_ones

# Only allow access from our local machines
#http_access allow local_nodes
http_access allow localhost

# Finally, deny all other access to this proxy
http_access deny all

minimum_expiry_time 0
maximum_object_size 1024 MB

cache_mem 128 MB
maximum_object_size_in_memory 128 KB
# 5 GB disk cache
cache_dir ufs /var/spool/squid 5000 16 256
</code>
</pre>
<pre class="language-shell command-line" data-prompt=$>
<code>sudo squid -k parse
sudo systemctl start squid
sudo systemctl enable squid
sudo systemctl status squid
sudo systemctl restart squid</code>
</pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d12eca793afb912a040cd1c047606b56>5.2 - CVMFS architecture</h1>
<div class=lead>CVMFS architecture</div>
<p>We store our singuarlity containers unpacked on CVMFS. We tried the DUCC tool in the beginning, but it was causing too many issues with dockerhub and we were rate limited. The script to unpack our singularity containers is here: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh>https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh</a></p>
<p>It gets called by a cronjob on the CVMFS Stratum 0 server and relies on the log.txt file being updated via an action in the neurocommand repository (<a href=https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh>https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh</a>)</p>
<p>The Stratum 1 servers then pull this repo from Stratum 0 and our desktops mount these repos (configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a>)</p>
<p>The startup script (<a href=https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh>https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh</a>) sets up CVMFS and tests which server is fastest during the container startup.</p>
<p>This can also be done manually:</p>
<pre class="language-shell command-line" data-prompt=$><code>sudo cvmfs_talk -i neurodesk.ardc.edu.au host info
sudo cvmfs_talk -i neurodesk.ardc.edu.au host probe
cvmfs_config stat -v neurodesk.ardc.edu.au</code></pre><blockquote>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9110e9d9e3591f58026d3d52fc7e72cb>5.3 - Setup Stratum 0 server</h1>
<div class=lead>Host a Stratum 0 server</div>
<h2 id=setup-a-stratum-0-server>Setup a Stratum 0 server:</h2>
<h3 id=setup-storage>Setup Storage</h3>
<p>(would object storage be better? -> see comment below under next iteration ideas)</p>
<pre class="language-shell command-line" data-prompt=$>
<code>lsblk -l
sudo mkfs.ext4 /dev/vdb
sudo mkdir /storage
sudo mount /dev/vdb /storage/ -t auto
sudo chown ec2-user /storage/
sudo chmod a+rwx /storage/</code>
</pre>
<pre class="language-shell command-line" data-prompt=$ data-output=2>
<code>sudo vi /etc/fstab
/dev/vdb  /storage    auto    defaults,nofail   0  2</code>
</pre>
<h3 id=setup-server>Setup server</h3>
<pre class="language-shell command-line" data-prompt=$ data-output="41, 44-52">
<code>sudo yum install vim htop gcc git screen
sudo timedatectl set-timezone Australia/Brisbane

sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs cvmfs-server

sudo systemctl enable httpd
sudo systemctl restart httpd

# sudo systemctl stop firewalld 

# restore keys:
sudo mkdir /etc/cvmfs/keys/incoming
sudo chmod a+rwx /etc/cvmfs/keys/incoming
cd connections/cvmfs_keys/
scp neuro* ec2-user@203.101.226.164:/etc/cvmfs/keys/incoming
sudo mv /etc/cvmfs/keys/incoming/* /etc/cvmfs/keys/

#backup keys: 
#mkdir cvmfs_keys
#scp opc@158.101.127.61:/etc/cvmfs/keys/neuro* .

sudo cvmfs_server mkfs -o $USER neurodesk.ardc.edu.au

cd /storage
sudo mkdir -p cvmfs-storage/srv/
cd /srv/
sudo mv cvmfs/ /storage/cvmfs-storage/srv/
sudo ln -s /storage/cvmfs-storage/srv/cvmfs/

cd /var/spool
sudo mkdir /storage/spool
sudo mv cvmfs/ /storage/spool/
sudo ln -s  /storage/spool/cvmfs .

cvmfs_server transaction neurodesk.ardc.edu.au

cvmfs_server publish neurodesk.ardc.edu.au</code>
</pre>
<pre class="language-shell command-line" data-prompt=$ data-ouput=2>
<code>sudo vi /etc/cron.d/cvmfs_resign</code>
</pre>
<pre class=language-shell>
<code>0 11 * * 1 root /usr/bin/cvmfs_server resign neurodesk.ardc.edu.au</code>
</pre>
<pre class="language-shell command-line" data-prompt=$ data-ouput=2>
<code>cat /etc/cvmfs/keys/neurodesk.ardc.edu.au.pub</code>
</pre>
<pre class=language-shell>
<code>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuV9JBs9uXBR83qUs7AiE
nSQfvh6VCdNigVzOfRMol5cXsYq3cFy/Vn1Nt+7SGpDTQArQieZo4eWC9ww2oLq0
vY1pWyAms3Y4i+IUmMbwNifDU4GQ1KN9u4zl9Peun2YQCLE7mjC0ZLQtLM7Q0Z8h
NwP8jRJTN+u8mRKzkyxfSMLscVMKhm2pAwnT1zB9i3bzVV+FSnidXq8rnnzNHMgv
tfqx1h0gVyTeodToeFeGG5vq69wGZlwEwBJWVRGzzr+a8dWNBFMJ1HxamrBEBW4P
AxOKGHmQHTGbo+tdV/K6ZxZ2Ry+PVedNmbON/EPaGlI8Vd0fascACfByqqeUEhAB
dQIDAQAB
-----END PUBLIC KEY-----</code>
</pre>
<h2 id=next-iteration-of-this>Next iteration of this:</h2>
<h3 id=use-object-storage>use object storage?</h3>
<ul>
<li>current implementation uses block storage, but this makes increasing the volume size a bit more work</li>
<li>we coulddn&rsquo;t get object storage to work on Oracle as it assumes AWS S3</li>
</ul>
<h3 id=optimize-settings-for-repositories-for-container-images>Optimize settings for repositories for Container Images</h3>
<p>from the CVMFS documentation:
Repositories containing Linux container image contents (that is: container root file systems) should use overlayfs as a union file system and have the following configuration:</p>
<pre><code>CVMFS_INCLUDE_XATTRS=true
CVMFS_VIRTUAL_DIR=true
</code></pre>
<p>Extended attributes of files, such as file capabilities and SElinux attributes, are recorded. And previous file system revisions can be accessed from the clients.</p>
<h2 id=currently-not-used>Currently not used</h2>
<p>We tested the DUCC tool in the beginning, but it was leading to too many docker pulls and we therefore replaced it with our own script: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh>https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh</a></p>
<p>This is the old DUCC setup</p>
<pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install cvmfs-ducc.x86_64
sudo -i
dnf install -y yum-utils 
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf install docker-ce docker-ce-cli containerd.io
systemctl enable docker
systemctl start docker
docker version
docker info

# leave root mode

sudo groupadd docker
sudo usermod -aG docker $USER
sudo chown root:docker /var/run/docker.sock
newgrp docker


vi convert_appsjson_to_wishlist.sh
export DUCC_DOCKER_REGISTRY_PASS=configure_secret_password_here_and_dont_push_to_github
cd neurodesk
git pull
./gen_cvmfs_wishlist.sh
cvmfs_ducc convert recipe_neurodesk_auto.yaml
cd ..


chmod +x convert_appsjson_to_wishlist.sh

git clone https://github.com/NeuroDesk/neurodesk/

# setup cron job
sudo vi /etc/cron.d/cvmfs_dockerpull
*/5 * * * * opc cd ~ && bash /home/opc/convert_appsjson_to_wishlist.sh



#vi recipe.yaml

##version: 1
#user: vnmd
#cvmfs_repo: neurodesk.ardc.edu.au
#output_format: '$(scheme)://$(registry)/vnmd/thin_$(image)'
#input:
#- 'https://registry.hub.docker.com/vnmd/tgvqsm_1.0.0:20210119'
#- 'https://registry.hub.docker.com/vnmd/itksnap_3.8.0:20201208'


#cvmfs_ducc convert recipe_neurodesk.yaml
#cvmfs_ducc convert recipe_unpacked.yaml</code>
</pre><blockquote>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c25efc2b343b28af52b4173ce3a803a3>5.4 - Setup Stratum 1 server</h1>
<div class=lead>Host a Stratum 1 server</div>
<p>The stratum 1 servers for the desktop are configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a></p>
<p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy.</p>
<h1 id=setup-a-stratum-1-server>Setup a Stratum 1 server:</h1>
<pre class="language-shell command-line" data-prompt=$>
<code>sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs-server squid
sudo yum install -y python3-mod_wsgi 

sudo sed -i 's/Listen 80/Listen 127.0.0.1:8080/' /etc/httpd/conf/httpd.conf

set +H
echo "http_port 80 accel" | sudo tee /etc/squid/squid.conf
echo "http_port 8000 accel" | sudo tee -a /etc/squid/squid.conf
echo "http_access allow all" | sudo tee -a /etc/squid/squid.conf
echo "cache_peer 127.0.0.1 parent 8080 0 no-query originserver" | sudo tee -a /etc/squid/squid.conf
echo "acl CVMFSAPI urlpath_regex ^/cvmfs/[^/]*/api/" | sudo tee -a /etc/squid/squid.conf
echo "cache deny !CVMFSAPI" | sudo tee -a /etc/squid/squid.conf
echo "cache_mem 128 MB" | sudo tee -a /etc/squid/squid.conf

sudo systemctl start httpd
sudo systemctl start squid
sudo systemctl enable httpd
sudo systemctl enable squid

echo 'CVMFS_GEO_LICENSE_KEY=kGepdzqbAP4fjf5X' | sudo tee -a /etc/cvmfs/server.local
sudo chmod 600 /etc/cvmfs/server.local

sudo mkdir -p /etc/cvmfs/keys/ardc.edu.au/

echo "-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwUPEmxDp217SAtZxaBep
Bi2TQcLoh5AJ//HSIz68ypjOGFjwExGlHb95Frhu1SpcH5OASbV+jJ60oEBLi3sD
qA6rGYt9kVi90lWvEjQnhBkPb0uWcp1gNqQAUocybCzHvoiG3fUzAe259CrK09qR
pX8sZhgK3eHlfx4ycyMiIQeg66AHlgVCJ2fKa6fl1vnh6adJEPULmn6vZnevvUke
I6U1VcYTKm5dPMrOlY/fGimKlyWvivzVv1laa5TAR2Dt4CfdQncOz+rkXmWjLjkD
87WMiTgtKybsmMLb2yCGSgLSArlSWhbMA0MaZSzAwE9PJKCCMvTANo5644zc8jBe
NQIDAQAB
-----END PUBLIC KEY-----" | sudo tee /etc/cvmfs/keys/ardc.edu.au/neurodesk.ardc.edu.au.pub


sudo cvmfs_server add-replica -o $USER http://203.101.226.164/cvmfs/neurodesk.ardc.edu.au /etc/cvmfs/keys/ardc.edu.au

# CVMFS will store everything in /srv/cvmfs so make sure there is enough space or create a symlink to a bigger storage volume
# e.g.:



sudo cvmfs_server snapshot neurodesk.ardc.edu.au


echo "/var/log/cvmfs/*.log {
    weekly
    missingok
    notifempty
}" | sudo tee /etc/logrotate.d/cvmfs


echo '*/5 * * * * root output=$(/usr/bin/cvmfs_server snapshot -a -i 2>&1) || echo "$output" ' | sudo tee /etc/cron.d/cvmfs_stratum1_snapshot

sudo yum install iptables
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000

sudo systemctl disable firewalld 
sudo systemctl stop firewalld 
# make sure that port 80 is open in the real firewall

sudo cvmfs_server update-geodb</code>
</pre><blockquote>
</blockquote>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel=noopener href=https://twitter.com/neuro_desk aria-label=Twitter>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dicussion Forum (requires github login)" aria-label="Dicussion Forum (requires github login)">
<a class=text-white target=_blank rel=noopener href=https://github.com/NeuroDesk/neurodesk.github.io/discussions aria-label="Dicussion Forum (requires github login)">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/neurodesk.github.io/js/tabpane-persist.js></script>
<script src=/neurodesk.github.io/js/main.min.3a75d46404b4b4835d9009c79b684ebaec265268791fa90da61c67d7d208378c.js integrity="sha256-OnXUZAS0tINdkAnHm2hOuuwmUmh5H6kNphxn19IIN4w=" crossorigin=anonymous></script>
<script src=/neurodesk.github.io/js/prism.js></script>
</body>
</html>